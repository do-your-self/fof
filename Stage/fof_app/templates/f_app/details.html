{% extends "main.html" %}

{% block css %}
<link href='../../static/vendors/fullcalendar-3.4.0/fullcalendar.min.css' rel='stylesheet' />
<link href='../../static/vendors/fullcalendar-3.4.0/fullcalendar.print.css' rel='stylesheet' media='print' />
<link href="../../static/vendors/bootstrapvalidator-0.5.3/dist/css/bootstrapValidator.css" rel="stylesheet" />
<link href="../../static/vendors/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css" rel="stylesheet" />
<style>
    .timeline .block {
      margin-left: 0!important;
    }
    .profile_details .profile_view .left {
      margin-top: 0!important;
    }
    .tile-stats {
      height: 168px;
    }

</style>
{% endblock %}

{% block content %}

<div>
  <div class="">
    <div class="page-title">
      <div class="title_left">
        {% if current_user.is_staff %}
        <h4>{{ fof.sec_name }}</h4>
        {% else %}
        <h4>{{ fof.sec_name if fof.alias is none else fof.alias }} </h4>
        {% endif %}
      </div>
      <div class="title_right">
        <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
          <div class="input-group">
          </div>
        </div>
      </div>
    </div>
    <div class="clearfix"></div>
    <div class="row">
      <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="" role="tabpanel" data-example-id="togglable-tabs">
          <ul id="myTab" class="nav nav-tabs nav-justified" role="tablist">
            <li role="presentation" class="active"><a href="#tab_content4" id="home-tab" role="tab"
                                                      data-toggle="tab" aria-expanded="true">净值信息</a>
            </li>
            <li role="presentation" class=""><a href="#tab_content2" role="tab" id="profile" data-toggle="tab"
                                                aria-expanded="false">子基金信息</a>
            </li>
            <li role="presentation" class=""><a href="#tab_content3" role="tab" id="profile-tab2" data-toggle="tab"
                                                aria-expanded="false">文件信息</a>
            </li>
            <li role="presentation" class=""><a href="#tab_content1" role="tab" id="profile-tab3" data-toggle="tab"
                                                aria-expanded="false">策略信息</a>
            </li>
            <li role="presentation" class=""><a href="#tab_content6" role="tab" id="profile-tab5" data-toggle="tab"
                                                aria-expanded="false">基金基本信息</a>
            </li>
            <li role="presentation" class=""><a href="#tab_content7" role="tab" id="profile-tab6" data-toggle="tab"
                                                aria-expanded="false">绩效分析</a>
            </li>
            <li role="presentation" class=""><a href="#tab_content8" role="tab" id="profile-tab7" data-toggle="tab"
                                                aria-expanded="false">相关日程</a>
            </li>
          </ul>
          <div id="myTabContent" class="tab-content">
            <div role="tabpanel" class="tab-pane active in" id="tab_content4" aria-labelledby="home-tab">
              <div class="dashboard_graph x_panel">
                <div class="x_title">
                  <div class="col-md-11">
                    <h4>净值信息</h4>
                  </div>
                  <div class="col-md-1">
                    <a style="font-size: 25px;" href="{{ url_for('f_app.change_acc',wind_code=fof.wind_code) }}">
                      <button class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> 添加净值</button>
                    </a>
                  </div>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <div class="col-lg-5 col-md-5 col-sm-5 btn-group" id="t4button"
                       style="position: absolute;top:70px;z-index: 99;">
                      <button class="btn btn-xs btn-info active" value="networth">净值</button>
                      <button class="btn btn-xs" value="scale">配比</button>
                  </div>
                  <div class="demo-container" style="height:400px" id="mainUp">
                    <div id="main" style="height:375px;"></div>
                    <div id="sub" style="height:375px;"></div>
                  </div>
                </div>
              </div>
              <!-- end of user-activity-graph -->
              <div class="contentStr col-xs-12">
                <ul class="list-group">
                  <li><b class="col-md-2 col-sm-2"> 截止：</b><span class="col-md-10 col-sm-10"
                                                                 style="padding-left: 0;">{{ date_latest }}</span>
                  </li>
                  <li><b class="col-md-2">最新净值：</b><span class="col-md-10 col-sm-10" style="padding-left: 0;">
             <ul style="padding-left: 0;">
               {% for i in fund_rr %}
               <li class="">{{ i | join('') | safe}}</li>
               {% endfor %}
             </ul>


           </span></li>
                </ul>
              </div>

              <table class="table table-bordered center-all" id="tab4" width="100%">
                <thead>
                <tr>
                  <th>净值时间</th>
                  <th>单位净值</th>
                  <th>累计净值</th>
                  <th>增长</th>
                </tr>
                </thead>
              </table>


            </div>
            <div role="tabpanel" class="tab-pane fade" id="tab_content1" aria-labelledby="profile-tab">
              <!-- start recent activity -->
              <div class="dashboard_graph x_panel">
                <div class="x_title">
                  <div class="col-md-11">
                    <h4>策略信息</h4>
                  </div>
                  <div class="col-md-1">
                    <a style="font-size: 25px;" href="{{ url_for('f_app.add_stg',wind_code=fof.wind_code) }}">
                      <button class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> 添加策略</button>
                    </a>
                  </div>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <div class="demo-container">
                    <div id="t1chart" style="height:500px;"></div>
                  </div>
                </div>
              </div>
              <table class="table table-bordered " id="tab1" width="100%">
                <thead>
                <tr>
                  <th>策略</th>
                  <th>规模</th>
                  <th>交易日期</th>
                </tr>
                </thead>

              </table>
              <!-- end recent activity -->
            </div>
            <div role="tabpanel" class="tab-pane fade" id="tab_content2" aria-labelledby="profile-tab"
                 style="position: relative;">
              <!-- start user projects -->

              <div class="dashboard_graph x_panel">
                <div class="x_title">
                  <div class="col-md-11">
                    <h4>子基金信息</h4>
                  </div>
                  <div class="col-md-1">
                    <a style="font-size: 25px;" href="{{ url_for('f_app.add_child',wind_code=fof.wind_code) }}">
                      <button class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> 添加子基金</button>
                    </a>
                  </div>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <div class="demo-container">
                    <div id="t2chart" style="height:500px;">
                  </div>
                </div>
              </div>

              </div>
              <div class="col-lg-5 col-md-5 col-sm-5 btn-group" id="t2button"
                   style="position: absolute;top:120px;left:20px;">
                <button class="btn btn-xs" value="batch">批次</button>
                <button class="btn btn-xs btn-info active" value="fund">基金</button>
              </div>
              <table class="table table-bordered center-all " id="tab2" width="100%">
                <thead>
                <tr>
                  <th>基金名称</th>
                  <th>规模</th>
                  <th>日期</th>
                </tr>
                </thead>

              </table>

              <!-- end user projects -->
            </div>
            <div role="tabpanel" class="tab-pane fade" id="tab_content3" aria-labelledby="profile-tab">
              <div class="x_panel fixed_height_390">
                <div class="x_title">
                  <div class="col-md-11">
                    <h2>文件信息</h2>
                  </div>                    
                  <div class="col-md-1">
                    <a href="{{ url_for('f_app.fof_upload',wind_code=fof.wind_code) }}">
                      <button class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> 添加文件</button>
                    </a>
                  </div>
                  <div class="clearfix"></div>
                </div>
                <table class="table table-bordered center-all" id="tab3" width="100%">
                  <thead>
                  <tr>
                    <th>文件名称</th>
                    <th>文件类型</th>
                    <th>上传时间</th>
                    <th></th>
                  </tr>
                  </thead>

                </table>
              </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="tab_content5" aria-labelledby="profile-tab">
              <div id="capital_data" style="height:500px;padding:10px;"></div>
              <div id="factor_data" style="height:500px;padding:10px;"></div>
              <table class="table table-bordered center-all" id="tab5" width="100%">
                <thead>
                <tr>
                  <th></th>
                  <th>Estimate</th>
                  <th>Std.Error</th>
                  <th>t.Value</th>
                  <th>Pr(>|t|)</th>
                </tr>
                </thead>
              </table>
              <div id="ci_dist_data" style="height:600px;padding:10px;"></div>
              <div id="ci_dist_pie" style="height:500px;padding:10px;"></div>
              <div id="ci_expo_data" style="height:600px;padding:10px;"></div>
              <div id="ci_expo_pie" style="height:600px;padding:10px;"></div>
              <div id="ci_expo_earn" style="height:600px;padding:10px;"></div>

            </div>
            <div role="tabpanel" class="tab-pane fade" id="tab_content8" aria-labelledby="profile-tab">
     <div class="">
            <div class="page-title">
              <div class="title_left">
                                <h2>{{ fof.sec_name}}  日程</h2>
              </div>
            </div>
            <div class="clearfix"></div>
            <div class="row">
              <div class="col-md-12">
                <div class="x_panel">
                    <div class="x_title">
                      <div class="form-group">
                          <label>
                               <b><i class="fa fa-battery-0"></i>创建</b>
                      <b><i class="fa fa-battery-2"></i>开始</b>
                      <b><i class="fa fa-battery-full"></i>到期</b>
                          </label>
                      </div>
                  </div>
                  <div class="x_content">
                 <div id='calendar'></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <div class="modal fade" id="crud">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button>
                        <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body">
                        <div class="error"></div>
                        <form class="form-horizontal" id="crud-form">
                            <div class="form-group">
                                <label class="col-md-3 control-label" for="title">事件类型</label>
                                <div class="col-md-9">
                                    <select class="form-control input-md" id="title">
                                        <option>现金管理</option>
                                        <option>投资事项</option>
                                        <option>投后事项</option>
                                        <option>法务事项</option>
                                        <option>其他事项</option>
                                    </select>
                                 <!--   <input id="title" name="title" type="text" class="form-control input-md" /> -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label" for="time">创建时间</label>
                                <div class="col-md-9 input-append ">
                                    <input id="create" name="create" type="date" class="form-control input-md" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label" for="time">提醒时间</label>
                                <div class="col-md-9 input-append ">
                                    <input id="start" name="start" type="date" class="form-control input-md" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label" for="time">到期时间</label>
                                <div class="col-md-9 input-append ">
                                    <input id="end" name="end" type="date" class="form-control input-md" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-3 control-label" for="description">详细</label>
                                <div class="col-md-9">
                                    <textarea class="form-control" id="description" name="description"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label" for="color">事件颜色</label>
                                <div class="col-md-9">
                                    <input id="color" name="color" type="text" class="form-control input-md" readonly="readonly" />
                                    <span class="help-block">点击选择一种颜色类型</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-3 control-label" for="color">公共/私有</label>
                                <div class="col-md-9" id="r1">
                                      <label class="radio-inline"><input type="radio" name="r1" value="private" id="private" >私有</label>
                                          <label class="radio-inline"><input type="radio" name="r1" value="public" id="public">公共</label>

                                </div>
                            </div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>

            </div>
            <div role="tabpanel" class="tab-pane fade" id="tab_content6" aria-labelledby="profile-tab">
              <div class="x_panel fixed_height_390">
                <div class="x_content">
                  <div class="col-md-7">
                    <div class="x_title">
                      <div class="col-md-11">
                        <h2>基金信息</h2>
                      </div>
                      <div class="col-md-1">
                        <a style="font-size: 25px;" href="{{ url_for('f_app.edit_summary',wind_code=fof.wind_code) }}"><i class="fa fa-edit"></i></a>
                      </div>
                      <div class="clearfix"></div>
                    </div>
                    <ul class="list-unstyled timeline">
                      <li>
                        <div class="block">
                          <div class="block_content">
                            <h2 class="title">
                              <a>基金管理人：</a><a>{% if current_user.is_staff %}
                          {{ fof.fund_mgrcomp | default("",True) }}
                          {% else %}
                          {{ "*****" | default("",True) }}
                          {% endif %}</a>
                            </h2>
                            <div class="byline">
                              <span></span><a></a>
                            </div>
                            <p class="excerpt">
                          <span>基金经理：</span><strong>{% if current_user.is_staff %}
                          {{ fof.fund_fundmanager | default("",True) }}
                          {% else %}
                          {{ "*****" | default("",True) }}
                          {% endif %}
                        </strong>
                            </p>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="block">
                          <div class="block_content">
                            <h2 class="title">
                              <a>基金策略类型：</a><a>{{ fof.strategy_type | default("",True) }}</a>
                            </h2>
                            <div class="byline">
                              <span></span><a></a>
                            </div>
                            <p class="excerpt">
                              <span>基金初始规模：</span><a>{{ fof.scale_tot | default("",True) }}</a>
                            </p>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="block">
                          <div class="block_content">
                            <h2 class="title">
                              <span>成立日期：</span><strong>{{ fof.fund_setupdate | default("",True) }}</strong>
                            </h2>
                            <div class="byline">
                              <span></span><a></a>
                            </div>
                            <p class="excerpt">
                              <span>终止日期：</span><a>{{ fof.fund_maturitydate | default("",True) }}</a>
                            </p>
                          </div>
                        </div>
                      </li>
                      <li>
                        <div class="block">
                          <div class="block_content">
                            <h2 class="title">
                              <a>投资负责人：</a><a>{{ fof.fh_inv_manager | default("",True) }}</a>
                            </h2>
                            <div class="byline">
                              <span></span><a></a>
                            </div>
                            <p class="excerpt">
                              <span>产品负责人：</span><a>{{ fof.fh_prod_manager | default("",True) }}</a>
                            </p>
                            <p class="excerpt">
                              <span>渠道负责人：</span><a>{{ fof.fh_channel_manager | default("",True) }} </a>
                            </p>
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                  <div class="col-md-5" style="border-left: 1px solid #ccc;">
                    <div class="x_title">
                      <div class="col-md-11">
                        <h2>联系人信息</h2>
                      </div>                    
                      <div class="col-md-1">
                        <a style="font-size: 25px;" href="{{ url_for('f_app.core_info',wind_code=fof.wind_code) }}"><i class="fa fa-edit"></i></a>
                      </div>
                      <div class="clearfix"></div>
                    </div>
                    {% if core_info is not none and  current_user.is_core %}
                      <div class="col-md-12 col-sm-12 col-xs-12 profile_details">
                        <div class="well profile_view col-md-12">
                          <div class="col-sm-12">
                            <h4 class="brief"><i>产品</i></h4>
                            <div class="left col-xs-12">
                              <h4>{{ core_info.product_contact_name }}</h4>
                              <ul class="list-unstyled">
                                <li><i style="padding-right:10px;" class="fa fa-phone"></i>{{ core_info.product_contact_phone }}</li>
                                <li><i style="padding-right: 10px;" class="fa fa-envelope"></i>{{ core_info.product_contact_email }}</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-12 col-sm-12 col-xs-12 profile_details">
                        <div class="well profile_view col-md-12">
                          <div class="col-sm-12">
                            <h4 class="brief"><i>基金</i></h4>
                            <div class="left col-xs-12">
                              <h4>{{ core_info.fund_manager_name }}</h4>
                              <ul class="list-unstyled">
                                <li><i style="padding-right:10px;" class="fa fa-phone"></i>{{ core_info.fund_manager_phone }}</li>
                                <li><i style="padding-right: 10px;" class="fa fa-envelope"></i>{{ core_info.fund_manager_email }}</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-12 col-sm-12 col-xs-12 profile_details">
                        <div class="well profile_view col-md-12">
                          <div class="col-sm-12">
                            <h4 class="brief"><i>其他</i></h4>
                            <div class="left col-xs-12">
                              <h4>{{ core_info.other_contact_name }}</h4>
                              <ul class="list-unstyled">
                                <li><i style="padding-right:10px;" class="fa fa-phone"></i>{{ core_info.other_contact_phone }}</li>
                                <li><i style="padding-right: 10px;" class="fa fa-envelope"></i>{{ core_info.other_contact_email }}</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div style="text-align: center;font-size:15px;height:100%;padding:20px;background: #fafafa;border-radius: 5px;">
                        <i class="fa fa-user"> 没有联系人信息</i>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div role="tabpanel" class="tab-pane fade" id="tab_content7" aria-labelledby="profile-tab">        
            <div class="x_panel fixed_height_390">
              <div class="x_title">
                <div class="col-md-11">
                  <h4>基本净值信息</h4>
                </div>
                <div class="col-md-1">
                  <a style="font-size: 25px;" href="{{ url_for('f_app.benchmark',wind_code=fof.wind_code) }}">
                    <button class="btn btn-primary btn-sm"><i class="fa fa-line-chart"></i> 方案分析</button>
                  </a>
                </div>
                <div class="clearfix"></div>
              </div>
              <div class="x_content">

              <div id="content6" class="x_content">
              </div>

              </div>
            </div>
              <div id="t3chart" style="height:500px;padding:10px;"></div>
              <div id="t4chart" style="height:500px;padding:10px;"></div>
              <div id="t6chart" style="height:500px;padding:10px;"></div>
              <div id="t6cchart" style="height:500px;padding:10px;"></div>
              <div id="t7chart" style="height:500px;padding:10px;"></div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block script %}
<script src="../../static/vendors/echarts/dist/echarts.min.js"></script>
<script src="../../static/js/shine.js"></script>
<script src="../../static/js/details.js"></script>
<script src="../../static/vendors/moment/moment.js"></script>
<script src="../../static/vendors/bootstrapvalidator-0.5.3/dist/js/bootstrapValidator.js"></script>
<script src="../../static/vendors/fullcalendar-3.4.0/fullcalendar.js"></script>
<script src='../../static/vendors/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js'></script>
<script src='../../static/vendors/bootstrap-timepicker/js/bootstrap-timepicker.min.js'></script>
<script src="../../static/vendors/fullcalendar-3.4.0/locale/zh-cn.js"></script>
<script>

  var child = {{ child | tojson }};
  var stg = {{ stg | tojson }};
  var fund_file = {{ fund_file | tojson }};
  var time_line = {{ time_line | tojson }};
  var result = {{ result | tojson }};
  var data_name = {{ data_name | tojson }};
  var acc = {{ acc | tojson }};
  var stgCharts = {{ stg_charts | tojson }};
  var fhs = {{ fhs_obj | tojson }};
  var copula = {{ copula_obj |tojson }};
  var multi = {{ multi_obj | tojson }};
  var capital_data = {{ capital_data | tojson }};
  var nav_obj = {{ nav_obj | tojson }};
  var scale_obj = {{ scale_obj | tojson }};
  var year_periods = {{ year_periods | tojson }};
  var risk = {{ risk | tojson }};
  var drawback = {{ drawback | tojson }};

  function  t2charts(wind_code,displayType) {
   var obj = {"wind_code":wind_code,'disPlayType':displayType};
   $.ajax({
    url:'/f_app/get_child_charts',
    type:'POST',
    contentType: 'application/json',
    data:JSON.stringify(obj),
    dataType:'json',
    success:function (callback) {
      if(callback.status === 'ok') {
        if(callback.data.date.length == 0 && callback.data.value.length == 0){
          $('#t2chart').hide();
          $('#t2button').hide();
          $('#tab2_wrapper').css({
            paddingTop: '10px'
          })
        }
        var date = callback.data.date;
        var result = callback.data.value;
        var t2chart = echarts.init(document.getElementById('t2chart'),"shine");
        option = {
          timeline : {
            data : date,
            axisType: 'category',
            label : {
              formatter: function (s) {
               var d = new Date(s);
               var mon = d.getMonth() +1;
               var tDate = mon  + '月' + d.getDate() + '日';
               return tDate
             }
           },
           tooltip : {
            trigger: 'item',
            formatter:  " {b} "
          }
        },
        options : []
      };
      var value = result;
      for(var i=0;i<value.length;i++){
        var legend = value[i].map(function (obj) {
          return obj.name
        });
        var op =  {
          title : {
            text: '子基金比例',
            subtext: ''
          },
          tooltip : {
            trigger: 'item',
            formatter:  "{a} <br/>{b} : {c} ({d}%)"
          },
          legend: {
            left: 150,
            top: 10,
            width : 700,
            padding: [0,0,25,0],
            data:legend,
            itemGap: 4,
            itemHeight: 10
          },
          series: [
          {
            name: "持仓比例",
            type: 'pie',
            data:value[i],
            radius : '60%',
            center: ['50%', '55%'],
            itemStyle: {
              emphasis: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            },
            label: {
              normal: {
                formatter: '{b} {c}\n占比:{d}%',
                textStyle:{
                  fontSize:13
                }
              }
            }

          }
          ],
          toolbox: {
            show : true,
            orient: 'vertical',
            padding: 20,
            itemGap: 20,
            itemSize: 15,
            feature : {
              mark : {
                show: false
              },
              saveAsImage : {
                show: true,
                icon: 'M328 576h152V128h64v448h152L512 768 328 576z m568-64h-64v320H192V512h-64v384h768V512z'
              }
            },
            iconStyle: {
              normal: {
                color: "#09487e"
              }
            }
          }
        };
        option.options.push(op);
      }
      t2chart.setOption(option);
    }else{
      $('#t2chart').html("<p>暂时没有找到可用的数据</p> ");
    }
  }});
 }

 $(document).ready(function() {
    //tab1

    if(capital_data !== null){
      capital_charts(capital_data);
      factor_charts(capital_data);
      ci_dist_charts(capital_data);
      ci_expo_charts(capital_data);
      ci_expo_earn_charts(capital_data);
      tab5(capital_data)
    }else{
      $('#profile-tab4').hide()
    }
  });




 var table1 = $('#tab1').DataTable({
   "info":false,
   "paging": false,
   'data':stg,
   "language": {
    "lengthMenu": "每页 _MENU_ 条记录",
    "zeroRecords": "没有找到记录",
    "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
    "infoEmpty": "无记录",
    "search": "搜索：",
    "infoFiltered": "(从 _MAX_ 条记录过滤)",
    "paginate": {
      "previous": "上一页",
      "next": "下一页"
    }
  },
  columns: [
  { data: 'type' },
  { data: 'scale'},
  {data:'date'}

  ],
  "columnDefs": [{
    "visible": false,
    "targets": 2
  },{
    targets: "_all",
    orderable: false
  }
  ],
  "order": [[2, 'asc']],
  "displayLength": 10,
  "drawCallback": function(settings) {
    var api = this.api();
    var rows = api.rows({
      page: 'current'
    }).nodes();
    var last = null;

    api.column(2, {
      page: 'current'
    }).data().each(function(group, i) {
      if (last !== group) {
        $(rows).eq(i).before('<tr class="group"><td colspan="5">' + group + '</td></tr>');
        last = group;
      }
    });
  }
});


 if(stgCharts.date.length > 0 ){
   var t1chart = echarts.init(document.getElementById('t1chart'),"shine");
   option = {
    timeline : {
      data : stgCharts.date,
      axisType: 'category',
      label : {
        formatter: function (s) {
         var d = new Date(s);
         var mon = d.getMonth() +1;
         var tDate = mon  + '月' + d.getDate() + '日';
         return tDate
       }
     },
     tooltip : {
      trigger: 'item',
      formatter:  " {b} "
    }
  },
  options : []
};
var stg_legend = stg.map(function (obj) {
  return obj.type
});
for(var i=0;i<stgCharts.value.length;i++){

  var stg_op =  {
    title : {
      text: '策略比例',
      subtext: ''
    },
    tooltip : {
      trigger: 'item',
      formatter:  "{a} <br/>{b} : {c} ({d}%)"
    },
    legend: {
      left: 150,
      top: 2,
      data:stg_legend
    },
    toolbox: {
      show : true,
      orient: 'vertical',
      padding: 20,
      itemGap: 20,
      itemSize: 15,
      feature : {
        mark : {show: true},
        saveAsImage : {
          show: true,
          icon: 'M328 576h152V128h64v448h152L512 768 328 576z m568-64h-64v320H192V512h-64v384h768V512z'
        }
      },
      iconStyle: {
        normal: {
          color: "#09487e"
        }
      }
    }
  };

  for(var j=0;j<stgCharts.value[i].length;j++){
    stgCharts.value[i][j].value=Math.round(stgCharts.value[i][j].value)
  }
  stg_op.series = [{"name":"策略比例","type":'pie',label: {
    normal: {
      formatter: '{b} {c}\n占比:{d}%',
      textStyle:{
        fontSize:13
      }
    }
  },"data":stgCharts.value[i]}];
  option.options.push(stg_op);
}
t1chart.setOption(option);
}else{
  $('#t1chart').hide();
}
    //tab2
    var table2 = $('#tab2').DataTable({
      "info":false,
      "search":false,
      "paging": true,
      'data':child,
      "language": {
        "lengthMenu": "每页 _MENU_ 条记录",
        "zeroRecords": "没有找到记录",
        "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
        "infoEmpty": "无记录",
        "search": "搜索：",
        "infoFiltered": "(从 _MAX_ 条记录过滤)",
        "paginate": {
          "previous": "上一页",
          "next": "下一页"
        }
      },
      columns: [
      { data: 'name',
      "render": function(data, type, row) {

        var name = row['code'];
        if(name === 'fh0000'){
          return row['name']
        }else{
          return "<a href=/f_app/details/"+name+">"+data;}
        }},
        { data: 'scale'},
        { data: 'date' }
        ],
        "columnDefs": [{
          "visible": false,
          "targets": 2
        },{
          targets: "_all",
          orderable: false
        }

        ],
        "order": [[2, 'desc']],
        "displayLength": 10,
        "drawCallback": function(settings) {
          var api = this.api();
          var rows = api.rows({
            page: 'current'
          }).nodes();
          var last = null;

          api.column(2, {
            page: 'current'
          }).data().each(function(group, i) {
            if (last !== group) {
              $(rows).eq(i).before('<tr class="group info" ><td colspan="5">' + group + '</td></tr>');
              last = group;
            }
          });
        }
      });

            // 根据组排序
            //tab3
            if (fund_file !== undefined ) {
              var tab3 = $('#tab3').DataTable({
                "info": false,
                "paging": false,
                "data": fund_file,
                "search": false,
                "filter": false,
                "language": {
                  "lengthMenu": "每页 _MENU_ 条记录",
                  "zeroRecords": "没有找到记录",
                  "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                  "infoEmpty": "无记录",
                  "search": "搜索：",
                  "infoFiltered": "(从 _MAX_ 条记录过滤)",
                  "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                  }
                },
                "columns": [
                {"data": "name"},
                {"data": "type"},
                {"data": "date"},
                {
                  data: 'action',
                  "render": function (data, type, row) {
                    return '<a href=/f_app/read_file/?id='+data + '><button type="button" class="btn btn-info btn-xs">查看</button></a>' +
                    '<button type="button" class="btn btn-success btn-xs delfile">删除</button>';
                  }
                }
                ],
                "columnDefs": [
                { "width": "45%", "targets": 0 }
                ]
              })
            }else{
             var tab3 = $('#tab3').DataTable({
              "info": false,
              "paging": false,
              "data": fund_file,
              "search": false,
              "filter": false,
              "columns": [
              {"data": "name"},
              {"data": "type"},
              {"data": "date"},
              {"data": 'action'}
              ]
            })
           }
           $('#tab3 tbody').on( 'click', '.delfile', function (e) {
            var data = tab3.row( $(this).parents('tr') ).data();
            var obj = {"fid":data['action']};
            e.preventDefault();
            if (confirm("确定要删除文件?")) {
             tab3.row($(this).parents('tr')).remove().draw();
             $.ajax({
              url:'/f_app/del_file',
              type:'POST',
              contentType: 'application/json',
              data:JSON.stringify(obj),
              dataType:'json',
              success:function (callback) {
              }
            });
           }});
           $('#tab4').DataTable({
             "scrollX": false,
             "info":false,
             "paging": false,
             "data": acc,
             "search":false,
             "filter":false,
             "columns": [
             {"data": "nav_date"},
             {"data": "nav_acc"},
             {"data": "nav"},
             {"data":"pct"}
             ]
           });


           $('#profile').on('click',function () {
            var wind_code = {{ fof.wind_code | tojson}};
            t2charts(wind_code,'fund');
          });
           $("#t2button > button.btn").on("click", function(){
            $(".btn-group > .btn").removeClass("active btn-info");
            var disPlayType = this.value;
            $(this).addClass('active btn-info');
            var wind_code = {{ fof.wind_code | tojson}};
            t2charts(wind_code,disPlayType);
          });
            var legendSwitch = {};
            for(var i=0;i<data_name.length;i++){
                if(i===0 || i===data_name.length-1){
                    legendSwitch[data_name[i]] = true;
                }else{
                    legendSwitch[data_name[i]] = false;
                }
            }

            //子基金配比
            if(JSON.stringify(scale_obj)!=="{}"){
              $("#t4button > button.btn").on("click", function(){
                $(".btn-group > .btn").removeClass("active btn-info");
                $(this).addClass('active btn-info');
                var disPlayType = this.value;
                if(disPlayType=="networth"){
                  $("#main").show().siblings().hide();
                }else{
                  $("#sub").show().siblings().hide();
                }
              });


            var echartLine = echarts.init(document.getElementById('sub'), "shine");
            var selfName = data_name[0];

            option = {
              title : {
                text: '子基金配比',
                subtext: '一年内子基金配比'
              },
              color:['#c12e34','#e6b600', '#0098d9', '#2b821d', '#005eaa','#339ca8',  '#ca8622', '#b9950a','#32a487', '#546570', '#c4ccd3','#96b9d8','#296eab','#0becb3','#c7817f','#795310','#2ce4f9','#d9f35c','#8bf320','#4c4c4b'],
              tooltip : {
                trigger: 'axis',
                formatter:function (obj) {
                 var result = '';
                 var date ;
                 for(var i=0;i<obj.length;i++){
                  var value;
                  if(isNaN(obj[i].value)){
                   value  = "----";
                 }else{
                  value = obj[i].data
                }
                if(i === (obj.length -1)){
                  date = obj[i].axisValue;
                }
                result +=
                '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:' + obj[i].color +'"></span>'+obj[i].seriesName +'&nbsp;'+ value +'<br>';
                    }
                    return "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+date+"<br />"+result
                  }
                },
                dataZoom: [
                  {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                  }
                ],
                legend: {
                  orient: 'horizontal',
                  top: 0,
                  left: 150,
                  width : 1200,
                  padding: [0,10,10,0],
                  data: '',
                  itemGap: 10,
                  itemHeight: 10,
                  formatter: function (data) {
                      return data+'   '
                  }
                },
                grid:{
                  y2: 90,
                  top: 80
                },
                toolbox: {
                  show : true,
                  orient: 'vertical',
                  padding: 20,
                  itemGap: 20,
                  itemSize: 15,
                  feature : {
                    saveAsImage : {
                      show: true,
                      icon: 'M328 576h152V128h64v448h152L512 768 328 576z m568-64h-64v320H192V512h-64v384h768V512z'
                    }

                  },
                  iconStyle: {
                    normal: {
                      color: "#09487e"
                    }
                  }
                },
                calculable : true,
                xAxis : [
                {
                  type : 'category',
                  boundaryGap : false,
                  data : '',
                  splitLine:{
                    　　　　show:true
                  　　 }

                }
                ],
                yAxis : [
                {
                  type : 'value',
                  scale:true,
                  axisLabel : {
                      formatter: '{value}   '
                  }

                },
                {
                  type : 'value',
                  name:'',
                  axisLabel : {
                      formatter: '   {value}'
                  }
                }
                ],
                series : [

                ]
              };
              var legend_data=[];
              var time=[];
              var line_data=[];
              var lineObj = {'name':result[0].name,"type":'line',"smooth":true,'data':''};
              for(k in nav_obj.nav_acc){
                time.push(k);
                line_data.push(nav_obj.nav_acc[k]);
              }
              option.xAxis[0].data=time;
              lineObj.data=line_data;
              option.series.push(lineObj);
              legend_data.push(result[0].name);
              for(k in scale_obj){
                legend_data.push(k);
              }
              for(k in scale_obj){
                var barObj = {'name':k,"type":'bar',"smooth":true,
                  yAxisIndex:1,
                  stack: '总量',
                  label: {
                      normal: {
                          show: false,
                          position: 'insideRight'
                      }
                  },'data':'',barWidth:30};
                var data=[];
                for(k2 in scale_obj[k]){
                  data.push(Math.round(scale_obj[k][k2]));
                }
                barObj.data=data;
                option.series.push(barObj);
              }
              option.legend.data=legend_data;
              echartLine.setOption(option);

              $("#sub").hide();
            }else{
              $("#t4button").hide();
            }



           if (time_line.length > 0  ){

            var echartLine = echarts.init(document.getElementById('main'), "shine");
            var selfName = data_name[0];

            option = {
              title : {
                text: '历史净值走势',
                subtext: '一年内历史净值走势'
              },
              tooltip : {
                trigger: 'axis',
                formatter:function (obj) {
                 var result = '';
                 var date ;
                 for(var i=0;i<obj.length;i++){
                  var value;
                  if(isNaN(obj[i].value)){
                   value  = "----";
                 }else{
                  value = obj[i].data.toFixed(4)
                }
                if(i === (obj.length -1)){
                  date = obj[i].axisValue;
                }
                result +=
                '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:' + obj[i].color +'"></span>'+obj[i].seriesName +'%&nbsp;'+ value +'<br>';
              }
              return "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+date+"<br />"+result
            }
          },
          dataZoom: [
            {
              type: 'slider',
              show: true,
              xAxisIndex: [0],
              start: 0,
              end: 100
            }
          ],
          legend: {
            orient: 'horizontal',
            top: 0,
            left: 150,
            width : 1200,
            padding: [0,10,10,0],
            data: data_name,
            itemGap: 10,
            itemHeight: 10,
            selected: legendSwitch,
            formatter: function (data) {
                return data+'   '
            }
          },
          grid:{
            y2: 90,
            top: 80
          },
          toolbox: {
            show : true,
            orient: 'vertical',
            padding: 20,
            itemGap: 20,
            itemSize: 15,
            feature : {
              myTool1: {
                show: true,
                title: '导出数据',
                icon: 'M512 128l184 192H544v448h-64V320H328l184-192z m384 384h-64v320H192V512h-64v384h768V512z',
                onclick: function (){
                  var form = $("<form>");
                  form.attr("style","display:none");
                  form.attr("target","");
                  form.attr("method","get");
                  form.attr("action",'/f_app/download_main_charts');
                  var input1 = $("<input>");
                  input1.attr("type","hidden");
                  input1.attr("name","wind_code");
                  input1.attr("value",{{ fof.wind_code|tojson |safe }});
                  $("body").append(form);
                  form.append(input1);
                  form.submit();
                  form.remove();
                }
              },
              saveAsImage : {
                show: true,
                icon: 'M328 576h152V128h64v448h152L512 768 328 576z m568-64h-64v320H192V512h-64v384h768V512z'
              }

            },
            iconStyle: {
              normal: {
                color: "#09487e"
              }
            }
          },
          calculable : true,
          xAxis : [
          {
            type : 'category',
            boundaryGap : false,
            data : time_line,
            splitLine:{
              　　　　show:true
            　　 }

          }
          ],
          yAxis : [
          {
            type : 'value',
            scale:true

          }
          ],
          series : [

          ]
        };
        for(var i=0;i<result.length;i++){
          var lineObj = {'name':result[i].name,"type":'line',"smooth":true,'data':result[i].data};
          option.series.push(lineObj);
        }
        echartLine.setOption(option);
      }else{
        $('#mainUp').hide()
      }
     //t2chart

   // fhs chart
   if (fhs.time !== undefined){
    var timeLine = fhs.time;
    var t6chart = echarts.init(document.getElementById('t6chart'),"shine");
    var show_count = fhs.show_count;
    if(show_count <=10) {
      show_count = 1000;
    }
    option = {
      title : {
        text: 'FHS-GARCH压力测试分析',
        subtext: '基于'+show_count+'次压力测试结果分位数显示'
      },
      tooltip : {
        trigger: 'axis',
        formatter:function(obj){
          var result = '';
          var i = obj.length;
          while(i--){
            result +=
            '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:' + obj[i].color +'"></span>'+obj[i].seriesName * 100+'%&nbsp;'+ obj[i].data.toFixed(4)+'<br>';
          }
          return result
        }
      },
      toolbox: {
        show : true,
        feature : {
          mark : {show: true},
          dataView : {show: true, readOnly: false},
          magicType : {show: true, type: ['line', 'bar']},
          restore : {show: true},
          saveAsImage : {show: true}
        }
      },
      calculable : true,
      xAxis : [
      {
        type : 'category',
        boundaryGap : false,
        data : timeLine,
        splitLine:{
          　　　　show:true
        　　 }
      }
      ],
      yAxis : [
      {
        type : 'value',
        scale:true
      }
      ],
      series : [
      ]
    };
    for(var x=0;x<fhs.data.length;x++){
      var name = fhs.data[x].name;
      var data = fhs.data[x].data;
      option.series.push({"name":name,"type":"line","data":data,"smooth":true})
    }
    t6chart.setOption(option);

  }else{
            //$("#t6chart").hide();
            $("#t6chart").html("<p>FHS-GARCH压力测试暂时没有找到可用的数据</p> ")
          }
          if (copula.x  !== undefined){
            var echartBar = echarts.init(document.getElementById('t6cchart'), "shine");
            echartBar.setOption({
              title: {
                text: "Copula压力测试分析",
                subtext: '基于1000次压力测试结果'
              },
              tooltip: {
                trigger: 'axis'
              },
              legend: {
                data: ['sales', 'purchases']
              },
              toolbox: {
                show : true,
                feature : {
                  mark : {show: true},
                  dataView : {show: true, readOnly: false},
                  magicType : {show: true, type: ['line', 'bar']},
                  restore : {show: true},
                  saveAsImage : {show: true}
                }
              },
              calculable: false,
              xAxis: [{
                type: 'category',
                data:copula.x

              }],
              yAxis: [{
                type: 'value',
                scale:true
              }],
              series : [
              {
                name:'频率',
                type:'bar',
                data:copula.y
              }
              ]
            });
          }else{
            $("#t6cchart").html("<p>copula压力测试暂时没有找到可用的数据</p> ")
          }

        // tab7
        if (multi.legend.length >0){
         var echartRadar = echarts.init(document.getElementById('t7chart'), "shine");
         echartRadar.setOption({
          title: {
            text: '多因子分析'
          },
          tooltip: {
            trigger: 'item'
          },
          legend: {
            orient: 'vertical',
            x: 'top',
            y: 'bottom',
            data: multi.legend
          },
          toolbox: {
            show: true,
            feature: {
              restore: {
                show: true,
                title: "Restore"
              },
              saveAsImage: {
                show: true,
                title: "Save Image"
              }
            }
          },
          polar: [{
            indicator: multi.indicator
          }],
          calculable: true,
          series: [{
            name: '多因子分析',
            type: 'radar',
            data: multi.series
          }]
        });
       }else{
        $('#t7chart').html("<p>暂时没有找到可用的数据</p> ")
      }
    //



$("#profile-tab6").click(function(){
  // content6
var html="";
html+=`
    <div class="row">
      <div class="animated flipInY col-lg-3 col-md-3 col-sm-3 col-xs-12">
        <div class="tile-stats">
          <div class="icon"><i class="fa fa-line-chart"></i>
          </div>
          <div class="count">${risk['最终净值']}</div>

          <h4 style="margin-left:10px">最终净值</h4>
          <p>最低净值: ${risk['最低净值']}</p>
          <p>区间收益率: ${risk['区间收益率']}</p>
          <p>起始日期: ${moment(risk['起始日期']).format('YYYY-MM-DD')} | 截止日期: ${moment(risk['截止日期']).format('YYYY-MM-DD')}</p>
        </div>
      </div>
      <div class="animated flipInY col-lg-3 col-md-3 col-sm-3 col-xs-12">
        <div class="tile-stats">
          <div class="icon"><i class="fa fa-area-chart"></i>
          </div>
          <div class="count">${risk['年化收益率']}</div>

          <h4 style="margin-left:10px">年化收益率</h4>
          <p>年化波动率: ${risk['年化波动率']}</p>
          <p>年化下行波动率: ${risk['年化下行波动率']}</p>
          <p>最大回撤: ${risk['最大回撤']}</p>
        </div>
      </div>
      <div class="animated flipInY col-lg-3 col-md-3 col-sm-3 col-xs-12">
        <div class="tile-stats">
          <div class="icon"><i class="fa fa-pie-chart"></i>
          </div>
          <div class="count">${risk['夏普率']}</div>

          <h4 style="margin-left:10px">夏普率</h4>
          <p>索提诺比率: ${risk['索提诺比率']}</p>
          <p>卡马比率: ${risk['卡马比率']}</p>

        </div>
      </div>
      <div class="animated flipInY col-lg-3 col-md-3 col-sm-3 col-xs-12">
        <div class="tile-stats">
          <div class="icon"><i class="fa fa-bar-chart"></i>
          </div>

            <p>盈亏比: ${risk['盈亏比']}</p>
            <p>胜率: ${risk['胜率']}</p>
            <p>最长不创新高（周）: ${risk['最长不创新高（周）']}</p>
            <p>统计周期最大收益: ${risk['统计周期最大收益']}</p>
            <p>统计周期最大亏损: ${risk['统计周期最大亏损']}</p>
            <p>最大月收益: ${risk['最大月收益']}</p>
            <p>最大月亏损: ${risk['最大月亏损']}</p>
        </div>
      </div>
    </div>
`;




  $('#content6').html(html);

  //月度收益率
  var date=Object.keys(year_periods).sort();
  var values=[];
  for(var i=0;i<date.length;i++){
    values.push(year_periods[date[i]]);
  }

  var option = {
      title: {
          text: '月度收益率'
      },
      tooltip: {
          trigger: 'axis'
      },
      legend: {
        orient: 'horizontal',
        top: 0,
        left: 150,
        width : 1200,
        padding: [0,10,10,0],
        data: '',
        itemGap: 10,
        itemHeight: 10
      },
      grid:{
        y2: 90,
        top: 80
      },
      toolbox: {
        show : true,
        feature : {
          mark : {show: true},
          dataView : {show: true, readOnly: false},
          magicType : {show: true, type: ['line', 'bar']},
          restore : {show: true},
          saveAsImage : {show: true}
        }
      },
      xAxis: {
          type: 'category',
          boundaryGap: false,
          data: date,
          splitLine:{
            　　　　show:true
          　　 }
      },
      yAxis: {
          type: 'value',
          scale:true
      },
      series: [
          {
              name:'月度收益率',
              type:'line',
              stack: '总量',
              data: values
          }
      ]

  };

  var t3chart = echarts.init(document.getElementById('t3chart'),"shine");
  t3chart.setOption(option);

  var option_sub = {
      title: {
          text: '回撤分析'
      },
      tooltip: {
          trigger: 'axis'
      },
      legend: {
        orient: 'horizontal',
        top: 0,
        left: 150,
        width : 1200,
        padding: [0,10,10,0],
        data: '',
        itemGap: 10,
        itemHeight: 10
      },
      grid:{
        y2: 90,
        top: 80
      },
      toolbox: {
        show : true,
        feature : {
          mark : {show: true},
          dataView : {show: true, readOnly: false},
          magicType : {show: true, type: ['line', 'bar']},
          restore : {show: true},
          saveAsImage : {show: true}
        }
      },
      xAxis: {
          type: 'category',
          boundaryGap: false,
          data: Object.keys(drawback),
          splitLine:{
            　　　　show:true
          　　 }
      },
      yAxis: {
          type: 'value',
          scale:true
      },
      series: [
          {
              name:'回撤分析',
              type:'line',
              stack: '总量',
              data: Object.values(drawback)
          }
      ]

  };

  var t4chart = echarts.init(document.getElementById('t4chart'),"shine");
  t4chart.setOption(option_sub);
})



//相关日程


$("#profile-tab7").click(function(){
      function  privateCheck(typeStr) {
        if(typeStr === "private"){
            return true
        }else{
            return false
        }
    }

    $('#crud').on('hidden.bs.modal', function () {
            $('#crud-form').bootstrapValidator('resetForm', true);
        });

    $(function(){
    var currentDate; // Holds the day clicked when adding a new event
    var currentEvent; // Holds the event object when editing an event
    $('#color').colorpicker(); // Colopicker

    $('#calendar').fullCalendar({

         header: {
          left: 'today ',
          center: 'prev title  next',
          right: 'month,agendaWeek'
          },
        // Get all events stored in database
        // Handle Day Click
{#        events: {url: '/f_app/query_cal/'+ {{ fof.wind_code |tojson }} + "/"#}
{#                        },#}
        eventRender: function(event, element){
                var today = moment();
                element.find('.fc-time').hide();

                    if(today.isAfter(event.start,'d')){
                   element.find('.fc-title').append(" " + event.tag  +"<br/><del>" + event.desc+"</del>");

                }else{
                    element.find('.fc-title').append("  " + event.tag  +"<br/>" + event.desc);
                }




            },
        events: function(start, end, timezone, callback) {
        $.ajax({
            url: '/f_app/query_cal/'+ {{ fof.wind_code |tojson }} +'/',
            type:'GET',
            contentType: 'application/json',
            dataType:'json',
            data: {
                // our hypothetical feed requires UNIX timestamps
                start: start.unix(),
                end: end.unix()
            },
            success: function(doc) {

                callback(doc);
            }
        });
    },
        dayClick: function(date, event, view) {

            currentDate = date.format();
            // Open modal to add event
            modal({
                // Available buttons when adding
                buttons: {
                    add: {
                        id: 'add-event', // Buttons id
                        css: 'btn-success', // Buttons class
                        label: '添加' // Buttons label
                    }                },
                title: '添加新的事件 (' + date.format() + ')' // Modal title
            });
        },
        // Event Mouseover
        eventMouseover: function(calEvent, jsEvent, view){
            var tooltip;
            if(calEvent.user){
                tooltip = '<div class="event-tooltip">由' +  calEvent.user+"创建</br>" + calEvent.desc + '</div>';
            }else{
                tooltip = '<div class="event-tooltip">' +  calEvent.desc + '</div>';
            }
            $("body").append(tooltip);
            $(this).mouseover(function(e) {
                $(this).css('z-index', 10000);
                $('.event-tooltip').fadeIn('500');
                $('.event-tooltip').fadeTo('10', 1.9);
            }).mousemove(function(e) {
                    $('.event-tooltip').css('top', e.pageY + 10);
                    $('.event-tooltip').css('left', e.pageX + 20);
                });
        },
        eventMouseout: function(calEvent, jsEvent) {
            $(this).css('z-index', 8);
            $('.event-tooltip').remove();
        },
        // Handle Existing Event Click
        eventClick: function(calEvent, jsEvent, view) {
            // Set currentEvent variable according to the event clicked in the calendar
            currentEvent = calEvent;
            // Open modal to edit or delete event
            modal({
                // Available buttons when editing
                buttons: {
                    delete: {
                        id: 'delete-event',
                        css: 'btn-danger',
                        label: '删除'
                    },
                    update: {
                        id: 'update-event',
                        css: 'btn-success',
                        label: '更新'
                    }
                },
                title: '编辑事件 "' + calEvent.title + '"',
                event: calEvent
            });
        }
    });




    function modal(data) {
        // Set modal title
        $('.modal-title').html(data.title);
        // Clear buttons except Cancel
        $('.modal-footer button:not(".btn-default")').remove();
        // Set input values
        $('#title').val(data.event ? data.event.title  : '');
        if( ! data.event) {
            var now = new Date();
        } else {
            var start = moment(data.event.start).format('YYYY-MM-DD');
            var end = data.event.end_time;
            var create = data.event.create_time;
            var startTime = data.event.start_time;
            var Private = data.event.Private;
        }
        $('#start').val(startTime);
        $("#end").val(end);
        $('#description').val(data.event ? data.event.desc : '');
        $('#color').val(data.event ? data.event.color : '#3a87ad');
        $('#create').val(create);
        if(Private === true){
            $('#private').prop("checked",true)
        }else{
            $('#public').prop("checked",true)
        }
        $('#crud-form').bootstrapValidator({
            excluded: ':disabled',
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            title: {
                validators: {
                    notEmpty: {
                        message: '这个字段不能为空'
                    }
                }
            },
            description: {
                validators: {
                    notEmpty: {
                        message: '这个字段不能为空'
                    }
                }
            },
            create: {
                    validators: {
                        notEmpty: {
                            message: '这个字段不能为空'
                        },
                        date: {
                            format: 'MM/DD/YYYY',
                            max:'start',
                            message: '创建时间不能大于提醒时间'
                        }
                    }
                },
            start: {
                    validators: {
                        notEmpty: {
                            message: '这个字段不能为空'
                        },
                        date: {
                            format: 'MM/DD/YYYY',
                            max: 'end',
                            message: '提醒时间不能大于过期时间'
                        }
                    }
                },
             end: {
                    validators: {
                        notEmpty: {
                            message: '这个字段不能为空'
                        },
                        date: {
                            format: 'MM/DD/YYYY',
                            min: 'start',
                            message: '过期时间不能小于提醒时间'
                        }
                    }
                },
             r1: {
                validators: {
                    notEmpty: {
                        message: '这个字段不能为空'
                    }
                }
            }
        }
        });

        // Create Butttons
        $.each(data.buttons, function(index, button){
            $('.modal-footer').prepend('<button type="button" id="' + button.id  + '" class="btn ' + button.css + '">' + button.label + '</button>')
        });
        //Show Modal
        $('.modal').modal('show');

    }
    // Handle Click on Add Button
    $('.modal').on('click', '#add-event',  function(e){
        var bv = $('#crud-form').data('bootstrapValidator');
        bv.validate();
        if(bv.isValid()) {
            $.post('/f_app/add_cal/'+{{ fof.wind_code |tojson }}, {
                title: $('#title').val(),
                description: $('#description').val(),
                color: $('#color').val(),
                start:$('#start').val(),
                end:$("#end").val(),
                create:$("#create").val(),
                Private:privateCheck($('#r1 input:checked').val())

            }, function(result){
                $('.modal').modal('hide');
                $('#calendar').fullCalendar("refetchEvents");
            });
        }
    });
    // Handle click on Update Button
    $('.modal').on('click', '#update-event',  function(e){
            // Use Ajax to submit form data
            var bv = $('#crud-form').data('bootstrapValidator');
            bv.validate();
            if(bv.isValid()){
                 $.post('/f_app/edit_cal/'+{{ fof.wind_code |tojson }}, {
                id: currentEvent._id,
                title: $('#title').val(),
                description: $('#description').val(),
                color: $('#color').val(),
                start:$('#start').val(),
                end:$("#end").val(),
                create:$("#create").val(),
                Private:privateCheck($('#r1 input:checked').val())
            }, function(result){
                $('.modal').modal('hide');
                $('#calendar').fullCalendar("refetchEvents");
            });
            }
        });


    // Handle Click on Delete Button
    $('.modal').on('click', '#delete-event',  function(e){
        $.get('/f_app/del_cal?id=' + currentEvent._id, function(result){
            $('.modal').modal('hide');
            $('#calendar').fullCalendar("refetchEvents");
        });
    });

});
})





  </script>
  {% endblock %}